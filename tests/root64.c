/**
 * Test of integer square root. (c) duane bailey
 * This code exercises the integer root accelerator.
 *
 * Temporarily, this computes the root of a 32 bit value, along with remainder.
 * Value sent to instruction:
 *   n(32 bits):remainder(16 bits):root(16 bits)
 */
#include "rocc.h"


unsigned long swRoot(unsigned long n)
{
  long m = 0; // the remainder (possibly negative)
  unsigned long r = 0; // the root
  unsigned long v; // an intermediate value
  int i;
  for (i = 0; i < 32; i++) {
    v = (m<<2) | (n>>62); // drop down two bits of n
    n <<= 2;
    m = v-((r<<2)+1);
    if (m < 0) {
      m = v;
      r <<= 1;      // 0 bit computed
    } else {
      r = (r<<1)+1; // 1 bit computed
    }
  }
  return r;
}

static inline unsigned long hwRoot(unsigned long int n)
{
  unsigned long result;
  asm volatile ("fence"); // fence instructions used for timing delimiters only
  ROCC_INSTRUCTION_DS(0, result, n, 0);
  asm volatile ("fence");
  return result;
}

int main(void)
{
  unsigned long int vals[] = {18018694296749797100U, 17684682030948308746U, 495713773723685766U, 6833360520808260145U, 15190626359625328406U, 17999003387447292839U, 16994906046067848131U, 8346405242447061762U, 13535275324144090098U, 4688932007488202505U, 9859800967087740539U, 642799614351224049U, 8813782465403751680U, 15601282703625818340U, 11331928410978510029U, 16807921514116757502U, 13908568454198326365U, 3599848036110709691U, 2360316572635697811U, 17214638978816298682U, 15608059642425479091U, 14511270868300713107U, 2762322172800769360U, 10861611144454570157U, 2197753881102206035U, 2148219355820952967U, 13522535326736187463U, 17050663334622222147U, 18197683312622705175U, 14027040648277555335U, 1925550959178587167U, 326429017158070151U, 1304450422129997176U, 18108380194938071338U, 1796909117755269566U, 2958708626813328893U, 8195053099646169762U, 9766500779535503924U, 10798825353575170780U, 6054952337374243156U, 6587632428586099880U, 17777820748634570019U, 10550658948977335634U, 2700344095330353317U, 12206750620510768860U, 1390669998127102320U, 6603569697814124668U, 12680075972324372868U, 7173652849548410647U, 2023999479481771210U, 8174517769582782743U, 10587124844673716574U, 15365082185276781323U, 18072060079263066508U, 7725247636721470307U, 6460201821110586929U, 4576438111930919912U, 11426860567719387865U, 15762816452150088111U, 15893092549469295103U, 1955906959089669925U, 17545164703234131713U, 11994206086248614180U, 3470753823950778372U, 17090116854810637600U, 12908756822185743756U, 10164892500207831846U, 11983850570743295765U, 9050996703268948977U, 3222598994419025290U, 8665240266749537885U, 11582062753903844108U, 10141142212787978954U, 3187807977491598512U, 7965186348772819060U, 17694647080477232360U, 6700505164982825137U, 1995869605634673606U, 10280628485422970947U, 5267016592486526747U, 16580309548121501227U, 2271817077592802576U, 1842553357048194844U, 4313019248661360146U, 4408458395809384788U, 15195675232233575503U, 17259243031541339622U, 14679531722579997413U, 17309465456443972808U, 8782598390621638514U, 12808307991165053393U, 5657682495316818074U, 14543044006751757036U, 12072826842499851360U, 17305770986968739683U, 6924535040884605703U, 6699641249782111562U, 13762048195440566123U, 12718315519824427332U, 622399380663349415U};
  unsigned long int n,r;
  int i;
  for (i = 0; i < 100; i++) {
    n = vals[i];
    r = hwRoot(n);
    printf("Root(%u)=%u\n",n,r);
    if ((r*r > n) || ((r+1)*(r+1)) <= n) return n+1;
  }
  return 0;
}
